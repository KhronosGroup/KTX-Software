# üîß –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –¥–ª—è Emscripten 4.0.18

## ‚öôÔ∏è –ß—Ç–æ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ –≤ CMakeLists.txt

### 1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –≤–º–µ—Å—Ç–æ —Å–∫–æ—Ä–æ—Å—Ç–∏

**–î–æ:**
```cmake
add_compile_options( $<IF:$<CONFIG:Debug>,-O0$<SEMICOLON>-g,-O3> )
add_link_options( $<IF:$<CONFIG:Debug>,-gsource-map,-O3> )
```

**–ü–æ—Å–ª–µ:**
```cmake
if(EMSCRIPTEN)
    # Optimize for size in Release builds
    add_compile_options( $<IF:$<CONFIG:Debug>,-O0$<SEMICOLON>-g,-Oz> )
    add_link_options( $<IF:$<CONFIG:Debug>,-gsource-map,-Oz> )
else()
    add_compile_options( $<IF:$<CONFIG:Debug>,-O0$<SEMICOLON>-g,-O3> )
    add_link_options( $<IF:$<CONFIG:Debug>,-g,-O3> )
endif()
```

**–≠—Ñ—Ñ–µ–∫—Ç:** `-Oz` –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –Ω–∞ —Ä–∞–∑–º–µ—Ä, `-O3` –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å. –î–ª—è Web –≤–∞–∂–Ω–µ–µ —Ä–∞–∑–º–µ—Ä.

---

### 2. –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ–ª–∞–≥–∏ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

```cmake
set(
    KTX_EM_COMMON_LINK_FLAGS
    --bind
    "SHELL:-s MODULARIZE=1"
    "SHELL:-s EXPORT_ES6=1"
    "SHELL:-s FILESYSTEM=0"                    # ‚Üê –£–∂–µ –±—ã–ª–æ
    "SHELL:-s NO_EXIT_RUNTIME=1"
    "SHELL:-s ALLOW_MEMORY_GROWTH=1"
    "SHELL:-s EXPORTED_RUNTIME_METHODS=['ccall','cwrap','getValue','setValue','HEAPU8','GL','HEAP8']"
    "SHELL:-s GL_PREINITIALIZED_CONTEXT=1"
    # NEW: Size optimization flags
    "SHELL:-s AGGRESSIVE_VARIABLE_ELIMINATION=1"   # ‚Üê –ù–û–í–û–ï
    "SHELL:-s ELIMINATE_DUPLICATE_FUNCTIONS=1"     # ‚Üê –ù–û–í–û–ï
    $<$<CONFIG:Release>:--closure=1>               # ‚Üê –ù–û–í–û–ï
    $<$<CONFIG:Release>:-flto>                     # ‚Üê –ù–û–í–û–ï
)
```

**–ß—Ç–æ –¥–µ–ª–∞—é—Ç –Ω–æ–≤—ã–µ —Ñ–ª–∞–≥–∏:**

| –§–ª–∞–≥ | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç | –≠–∫–æ–Ω–æ–º–∏—è |
|------|------------|----------|
| `AGGRESSIVE_VARIABLE_ELIMINATION=1` | –£–¥–∞–ª—è–µ—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–µ–µ | ~5-10% |
| `ELIMINATE_DUPLICATE_FUNCTIONS=1` | –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ | ~3-5% |
| `--closure=1` | Google Closure Compiler –º–∏–Ω–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç JS | ~20-30% JS |
| `-flto` | Link Time Optimization - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ª–∏–Ω–∫–æ–≤–∫–µ | ~5-10% |

**–°—É–º–º–∞—Ä–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è:** ~30-50% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–∞–∑–º–µ—Ä—ã

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—Å -O3):
```
libktx.wasm:      1,747 KB (1.7 MB)
libktx_read.wasm:   770 KB
```

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—Å -Oz + —Ñ–ª–∞–≥–∏):
```
libktx.wasm:      ~900-1100 KB (–æ–∂–∏–¥–∞–µ—Ç—Å—è)
libktx_read.wasm: ~400-500 KB  (–æ–∂–∏–¥–∞–µ—Ç—Å—è)
```

### –ü–æ—Å–ª–µ gzip (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ):
```
libktx.wasm:      ~300-400 KB
libktx_read.wasm: ~150-200 KB
```

---

## üöÄ –ö–∞–∫ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å —Å –Ω–æ–≤—ã–º–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏

### –®–∞–≥ 1: –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—É—é —Å–±–æ—Ä–∫—É

```cmd
cd D:\sourceProject\repos\KTX-Software
rmdir /s /q build-emscripten-Release
rmdir /s /q build-web-release
```

### –®–∞–≥ 2: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å Emscripten

```cmd
C:\emsdk\emsdk_env.bat
```

### –®–∞–≥ 3: –°–æ–±—Ä–∞—Ç—å —Å –Ω–æ–≤—ã–º–∏ —Ñ–ª–∞–≥–∞–º–∏

```cmd
cd D:\sourceProject\repos\KTX-Software
build_web.bat
```

**–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:**

```cmd
emcmake cmake -B build-web-release -G Ninja ^
  -DCMAKE_BUILD_TYPE=Release ^
  -DKTX_FEATURE_GL_UPLOAD=OFF ^
  -DKTX_FEATURE_VK_UPLOAD=OFF ^
  -DKTX_FEATURE_WRITE=ON ^
  -DKTX_FEATURE_TOOLS=OFF ^
  -DKTX_FEATURE_TESTS=OFF

cd build-web-release
cmake --build . --config Release
cd ..
```

---

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤

```cmd
dir build-web-release\*.wasm
```

–ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä —É–º–µ–Ω—å—à–∏–ª—Å—è –Ω–∞ 30-50% –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å–æ —Å—Ç–∞—Ä–æ–π —Å–±–æ—Ä–∫–æ–π - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å—Ä–∞–±–æ—Ç–∞–ª–∏!

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–ª–∞–≥–∏ –≤ –ª–æ–≥–µ —Å–±–æ—Ä–∫–∏

–í–æ –≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∏–¥–Ω—ã:
```
-Oz
--closure 1
-flto
-s AGGRESSIVE_VARIABLE_ELIMINATION=1
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ES6 –º–æ–¥—É–ª–∏

```cmd
dir build-web-release\*.mjs
```

–§–∞–π–ª—ã –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ `.mjs`, –Ω–µ `.js`

---

## ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Closure Compiler –æ—à–∏–±–∫–∏

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫–∏ —Ç–∏–ø–∞:
```
ERROR: Closure compiler failed
```

**–†–µ—à–µ–Ω–∏–µ:** –û—Ç–∫–ª—é—á–∏—Ç–µ closure –≤ CMakeLists.txt:
```cmake
# –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É:
# $<$<CONFIG:Release>:--closure=1>
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: LTO —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏

`-flto` –º–æ–∂–µ—Ç —Å–∏–ª—å–Ω–æ –∑–∞–º–µ–¥–ª–∏—Ç—å —Å–±–æ—Ä–∫—É. –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –±—ã—Å—Ç—Ä–∞—è —Å–±–æ—Ä–∫–∞:
```cmake
# –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É:
# $<$<CONFIG:Release>:-flto>
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –†–∞–∑–º–µ—Ä –≤—Å—ë —Ä–∞–≤–Ω–æ –±–æ–ª—å—à–æ–π

–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
1. **WRITE=ON –≤–∫–ª—é—á–∞–µ—Ç —ç–Ω–∫–æ–¥–µ—Ä—ã** (~1 MB Basis/ASTC —ç–Ω–∫–æ–¥–µ—Ä–æ–≤)
   - –†–µ—à–µ–Ω–∏–µ: –°–æ–±–∏—Ä–∞–π—Ç–µ —Å `WRITE=OFF` –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ —Ç–æ–ª—å–∫–æ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞
2. **Debug symbols –Ω–µ —É–¥–∞–ª–µ–Ω—ã**
   - –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ BUILD_TYPE=Release
3. **–°—Ç–∞—Ä—ã–π –∫–µ—à CMake**
   - –†–µ—à–µ–Ω–∏–µ: –£–¥–∞–ª–∏—Ç–µ –ø–∞–ø–∫—É —Å–±–æ—Ä–∫–∏ –∏ –ø–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ

---

## üìã –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ñ–ª–∞–≥–æ–≤ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

| –§–ª–∞–≥ | –†–∞–∑–º–µ—Ä | –°–∫–æ—Ä–æ—Å—Ç—å | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|------|--------|----------|--------------|
| `-O0` | –ë–æ–ª—å—à–æ–π | –ú–µ–¥–ª–µ–Ω–Ω–æ | Debug —Ç–æ–ª—å–∫–æ |
| `-O1` | –°—Ä–µ–¥–Ω–∏–π | –°—Ä–µ–¥–Ω–µ | - |
| `-O2` | –°—Ä–µ–¥–Ω–∏–π | –ë—ã—Å—Ç—Ä–æ | –ë–∞–ª–∞–Ω—Å |
| `-O3` | –ë–æ–ª—å—à–µ -O2 | –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ | –°–∫–æ—Ä–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ |
| `-Oz` | **–ú–∏–Ω–∏–º—É–º** | –°—Ä–µ–¥–Ω–µ | **Web - –ª—É—á—à–∏–π –≤—ã–±–æ—Ä** |
| `-Os` | –ú–∞–ª–µ–Ω—å–∫–∏–π | –°—Ä–µ–¥–Ω–µ | –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ -Oz |

**–î–ª—è Web —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:** `-Oz` + `--closure=1` + `-flto`

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è Production (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä):
```cmd
build_web.bat
```

–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç:
- `libktx.mjs` + `libktx.wasm` (–ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –∑–∞–ø–∏—Å—å—é)
- `libktx_read.mjs` + `libktx_read.wasm` (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ)

### –î–ª—è PlayCanvas (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é):

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **libktx_read** (—Ç–æ–ª—å–∫–æ –¥–µ–∫–æ–¥–∏–Ω–≥):
```
libktx_read.mjs:  ~50 KB
libktx_read.wasm: ~400-500 KB (–ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
Gzip:             ~150-200 KB
```

–≠—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è:
‚úÖ –ß—Ç–µ–Ω–∏—è KTX2
‚úÖ –¢—Ä–∞–Ω—Å–∫–æ–¥–∏–Ω–≥–∞ –≤ BC1/BC7/ASTC/ETC2
‚úÖ –ü–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –º–∏–ø–º–∞–ø–æ–≤
‚úÖ –†–∞–±–æ—Ç—ã —Å cubemaps –∏ texture arrays

‚ùå –ù–µ –≤–∫–ª—é—á–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ KTX2 —Ñ–∞–π–ª–æ–≤ (–Ω–µ –Ω—É–∂–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)

---

## ‚úÖ Checklist

- [ ] –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–∞–ø–∫–∏ —Å–±–æ—Ä–∫–∏
- [ ] –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å Emscripten
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å `build_web.bat`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤ (–¥–æ–ª–∂–µ–Ω —É–º–µ–Ω—å—à–∏—Ç—å—Å—è)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ–∞–π–ª—ã `.mjs` (–Ω–µ `.js`)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å gzip –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —ç–∫–æ–Ω–æ–º–∏–∏

---

**–ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å —Å–±–æ—Ä–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞! üéâ**
