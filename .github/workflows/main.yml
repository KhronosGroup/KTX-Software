name: build_and_test

on:
  push:
    branches:
      - cmake

jobs:
  mac:
    runs-on: macOS-latest

    steps:
    - uses: actions/checkout@v1
      with:
        lfs: true
    - name: install_sdl2
      run: |
        if [ ! -f /usr/local/lib/cmake/SDL2/sdl2-config.cmake ]; then echo "Installing SDL2"; brew install SDL2; echo "Installed SDL2"; else echo "SDL2 already installed"; fi
    - name: install_vulkan_sdk
      env:
        VULKAN_VERSION: "1.1.121.1"
      run: |
        if [ ! -f /usr/local/lib/libvulkan.dylib ]; then echo "Installing Vulkan SDK"; rm -f "vulkan-sdk-${VULKAN_VERSION}.tar.gz" ; wget -q -O "vulkan-sdk-${VULKAN_VERSION}.tar.gz" "https://sdk.lunarg.com/sdk/download/${VULKAN_VERSION}/mac/vulkan-sdk.tar.gz"; tar -xzf "vulkan-sdk-${VULKAN_VERSION}.tar.gz"; cd "vulkansdk-macos-${VULKAN_VERSION}"; ./install_vulkan.py; else echo "Vulkan SDK already installed"; fi
    - name: configure_mac
      env:
        VULKAN_VERSION: "1.1.121.1"
      run: cmake . -Bbuild_mac -DCMAKE_BUILD_TYPE=Release  -DVULKAN_SDK="vulkansdk-macos-${VULKAN_VERSION}/macOS"
    - name: build_mac
      run: cmake --build build_mac
    - name: test_mac
      run: cmake --build build_mac --target test
    # - uses: actions/upload-artifact@master
    #   with:
    #     name: ktx_mac
    #     path: build_mac/libktx.dylib
