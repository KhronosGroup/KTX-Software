name: build_and_test

on:
  push:
    branches:
      - cmake

jobs:
  mac:
    runs-on: macOS-latest

    steps:
    - uses: actions/checkout@v1
      with:
        lfs: true
    - name: install_sdl2
      run: |
        if [ ! -f /usr/local/lib/cmake/SDL2/sdl2-config.cmake ]; then echo "Installing SDL2"; brew install SDL2; echo "Installed SDL2"; else echo "SDL2 already installed"; fi
    - name: install_vulkan_sdk
      env:
        VULKAN_VERSION: "1.1.121.1"
      run: |
        if [ ! -f /usr/local/lib/libvulkan.dylib ]; then echo "Installing Vulkan SDK"; rm -f "vulkan-sdk-${VULKAN_VERSION}.tar.gz" ; wget -q -O "vulkan-sdk-${VULKAN_VERSION}.tar.gz" "https://sdk.lunarg.com/sdk/download/${VULKAN_VERSION}/mac/vulkan-sdk.tar.gz"; tar -xzf "vulkan-sdk-${VULKAN_VERSION}.tar.gz"; cd "vulkansdk-macos-${VULKAN_VERSION}"; ./install_vulkan.py; else echo "Vulkan SDK already installed"; fi
    - name: configure_mac
      env:
        VULKAN_VERSION: "1.1.121.1"
      run: cmake . -Bbuild_mac -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="install_mac" -DVULKAN_SDK="vulkansdk-macos-${VULKAN_VERSION}/macOS"
    - name: build_mac
      run: cmake --build build_mac
    - name: test_mac
      run: cmake --build build_mac --target test
    # - uses: actions/upload-artifact@master
    #   with:
    #     name: ktx_mac
    #     path: build_mac/libktx.dylib
    - uses: actions/upload-artifact@master
      with:
        name: KTX-Software_macOS
        path: install_mac

  linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
      with:
        lfs: true
    - name: install_deps
      run: |
        sudo apt-get update
        sudo apt-get install apt-transport-https ca-certificates gnupg software-properties-common wget
        wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | sudo apt-key add -
        sudo apt-add-repository 'deb https://apt.kitware.com/ubuntu/ bionic main'
        wget -qO - http://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo apt-key add -
        sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-bionic.list http://packages.lunarg.com/vulkan/lunarg-vulkan-bionic.list
        sudo apt-get update
        sudo apt-get install cmake vulkan-sdk libsdl2-dev
    - name: configure_linux_64
      run: /usr/bin/cmake . -Bbuild_linux_64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="install_linux_64"
    - name: build_linux_64
      run: /usr/bin/cmake --build build_linux_64
    - uses: actions/upload-artifact@master
      with:
        name: KTX-Software_linux_64
        path: install_linux_64
